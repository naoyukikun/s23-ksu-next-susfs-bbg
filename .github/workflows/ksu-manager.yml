name: Build Wild_KSU (ksu-manager)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (SHA / tag / branch)"
        required: true
        default: "84dee43"
      buildType:
        description: "debug or release"
        type: choice
        options: [debug, release]
        default: release

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_TYPE: ${{ inputs.buildType || 'release' }}
      REF: ${{ inputs.ref || '84dee43' }}

    steps:
      # Optional – keeps logs/artifacts tied to your repo
      - name: Checkout stub
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        # Uncomment if AGP demands explicit packages:
        # with:
        #   packages: |
        #     platforms;android-34
        #     build-tools;34.0.0

      - name: Clone Wild_KSU and pin ref
        run: |
          set -euxo pipefail
          git clone https://github.com/WildKernels/Wild_KSU.git
          cd Wild_KSU
          git fetch --all --tags
          if git rev-parse --verify --quiet "${REF}^{commit}" >/dev/null; then
            git checkout "${REF}"
          else
            git fetch origin "${REF}"
            git checkout FETCH_HEAD
          fi
          git rev-parse --short HEAD
          git log -1 --pretty=oneline

      # ✅ Run Gradle cache only after the Gradle files exist
      - name: Gradle cache
        uses: gradle/gradle-build-action@v3
        with:
          build-root-directory: Wild_KSU

      - name: Make Gradle wrapper executable
        working-directory: Wild_KSU
        run: chmod +x ./gradlew

      - name: Build APK
        working-directory: Wild_KSU
        run: |
          set -euxo pipefail
          # Title-case suffix for Gradle task
          TAIL="$(tr '[:lower:]' '[:upper:]' <<< ${BUILD_TYPE:0:1})${BUILD_TYPE:1}"
          ./gradlew --no-daemon --stacktrace clean "assemble${TAIL}"

      - name: List APKs
        id: apk
        working-directory: Wild_KSU
        run: |
          set -e
          echo "files<<EOF" >> $GITHUB_OUTPUT
          find . -type f -path "*/build/outputs/apk/*/*.apk" -print >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ksu-manager-${{ github.run_id }}-${{ env.BUILD_TYPE }}
          path: Wild_KSU/**/build/outputs/apk/*/*.apk
          if-no-files-found: error

      # -------- OPTIONAL SIGNING --------
      # - name: Decode keystore
      #   if: ${{ env.BUILD_TYPE == 'release' }}
      #   working-directory: Wild_KSU
      #   run: echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
      #   env:
      #     ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      #
      # - name: Build signed Release
      #   if: ${{ env.BUILD_TYPE == 'release' }}
      #   working-directory: Wild_KSU
      #   env:
      #     ANDROID_KEYSTORE: keystore.jks
      #     ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #     ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      #     ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      #   run: ./gradlew --no-daemon --stacktrace clean assembleRelease
