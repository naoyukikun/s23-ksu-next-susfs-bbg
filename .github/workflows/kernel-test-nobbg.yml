# Script github action kanged from Ivan @reddxae with little bit my modification and addition
name: Build kernel (Wild_KSU, SUSFS 2.0, Manual hooks 1.6 TESTING)
on:
  #schedule:
    #- cron: '0 4 * * *'  # Runs every day at 04:00 UTC
  workflow_dispatch: # Allow manual trigger if needed
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4 

      - name: Set up the toolchain
        run: |
          sudo apt update
          sudo apt install -y lz4 liblz4-dev
          sudo apt install -y \
            bc bison build-essential curl flex \
            g++-multilib gcc-multilib git gnupg \
            lib32readline-dev lib32z1-dev \
            libelf-dev liblz4-tool libssl-dev \
            lzop zlib1g-dev pahole dwarves cpio zip \
            python3 python-is-python3 tar perl lz4 jq

      - name: Clone source
        run: |
          git clone --depth=1 -b android13-5.15 https://github.com/samsung-sm8550/kernel_samsung_sm8550-common.git kernel
          # git clone --depth=1 -b android13-5.15 https://github.com/naoyukikun/kernel_samsung_sm8550-common.git kernel

          # Determine the current kernel version
          echo "KERNEL_VERSION=$(grep -m1 '^SUBLEVEL =' ./kernel/Makefile | awk '{print $3}')" >> $GITHUB_ENV
          
      - name: Apply the Wild_KSU, SUSFS, manual hooks patch and Baseband Guard
        run: |
          set -euxo pipefail
          cd kernel
          # Determine the tag of the latest release of Wild_KSU
          echo "WILD_KSU_VERSION=$(curl -s "https://api.github.com/repos/Wildkernels/Wild_KSU/tags" \
          | jq -r '.[0].name' | sed 's/^v//' | tr -d '.')" >> $GITHUB_ENV

          # Integrate the latest version of Wild_KSU into the source
          curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild
          

          # Compute version code = commit count + 10200 (same scheme as KernelSU CI)
          COMMITS="$(git -C "./Wild_KSU" rev-list --count HEAD || echo 0)"
          WILD_VER_CODE=$((30000 + COMMITS))
          echo "WILD_VER_CODE=$WILD_VER_CODE" >> "$GITHUB_ENV"              
          
          # Integrate latest SUSFS
          git clone -b gki-android13-5.15 --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu

          # Determine susfs version
          cd susfs4ksu
          SUSFS_COMMIT=$(git rev-parse --short HEAD)
          SUSFS_VERSION=$(sed -n 's/.*#define[[:space:]]\+SUSFS_VERSION[[:space:]]\+"v\{0,1\}\([0-9.]\+\)".*/\1/p' kernel_patches/include/linux/susfs.h | tr -d '.')
          echo "SUSFS_VERSION=$SUSFS_VERSION" >> "$GITHUB_ENV"
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> "$GITHUB_ENV"
          cd ..

          # Begin susfs patching
          #cp ./susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./Wild_KSU/
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-android13-5.15.patch ./
          cp -rv ./susfs4ksu/kernel_patches/fs/* fs/
          cp -rv ./susfs4ksu/kernel_patches/include/linux/* include/linux/
          patch -p1 --fuzz=3 < ./50_add_susfs_in_gki-android13-5.15.patch
                    
          # Integrate Sukisu scope_min_manual_hooks_v1.6.patch
          curl -L -o manual-hook.patch https://github.com/SukiSU-Ultra/SukiSU_patch/raw/83aa64b7548890bb1f2eff6c990c03a1802df27b/hooks/scope_min_manual_hooks_v1.6.patch
          patch -p1 --fuzz=3 < manual-hook.patch
          echo "CONFIG_KSU_KPROBES_HOOK=n" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> ./arch/arm64/configs/gki_defconfig   

      - name: Add LRNG and Performance Tweaks
        run: |
          cd kernel

          # 1. Set Identity for patching
          git config --global user.email "ishaqluqman656@gmail.com"
          git config --global user.name "naoyukikun"
          
          # 2. Clone LRNG Repo
          git clone --depth=1 -b master https://github.com/smuellerDD/lrng.git ../lrng_src
          
          # --- STAGE 1: PRE-PATCHES ---
          echo "Stage 1: Applying 6-digit pre-patches..."
          for patch in ../lrng_src/backports/v60-5.15.197/v60-[0-9][0-9][0-9][0-9][0-9][0-9]*.patch; do
            echo "Applying $patch"
            patch -p1 < "$patch" || echo "⚠️ Pre-patch failed: $patch"
          done

          # --- STAGE 2: MAIN LRNG ---
          echo "Stage 2: Applying Main LRNG v6.0 patches..."
          for patch in ../lrng_src/kernel_patches/v6.0/*.patch; do
            if [[ "$patch" == *"0000-cover-letter"* ]]; then continue; fi
            echo "Applying $patch"
            patch -p1 --fuzz=3 < "$patch" || echo "⚠️ Main patch failed: $patch"
          done

          # --- STAGE 3: POST-PATCHES ---
          echo "Stage 3: Applying 2-digit post-patches (Ignoring errors)..."
          for patch in ../lrng_src/backports/v60-5.15.197/v60-[0-9][0-9]-*.patch; do
            echo "Applying $patch"
            patch -p1 < "$patch" || echo "⚠️ Post-patch skipped"
          done

          # --- FIX 1 & 2: MISSING API HEADERS ---
          if [ ! -f include/linux/hrtimer_api.h ]; then
            echo "#include <linux/hrtimer.h>" > include/linux/hrtimer_api.h
          fi
          if [ ! -f include/linux/ktime_api.h ]; then
            echo "#include <linux/ktime.h>" > include/linux/ktime_api.h
          fi

          # --- FIX 3: COMPATIBILITY SHIMS ---
          cat <<EOF > drivers/char/lrng/lrng_compat_shim.h
          #ifndef LRNG_COMPAT_SHIM_H
          #define LRNG_COMPAT_SHIM_H
          #include <asm/archrandom.h>
          #define lrng_process_ready_list() do {} while (0)
          static inline size_t arch_get_random_seed_longs(unsigned long *v, size_t max_longs) {
              size_t i;
              for (i = 0; i < max_longs; i++) {
                  if (!arch_get_random_seed_long(&v[i])) break;
              }
              return i;
          }
          static inline size_t arch_get_random_longs(unsigned long *v, size_t max_longs) {
              size_t i;
              for (i = 0; i < max_longs; i++) {
                  if (!arch_get_random_long(&v[i])) break;
              }
              return i;
          }
          #endif
          EOF
          sed -i '/#include "lrng_es_mgr.h"/i #include "lrng_compat_shim.h"' drivers/char/lrng/lrng_es_mgr.c

          # --- FIX 4: NUCLEAR OPTION (Disable ALL Static Assertions) ---
          # Instead of trying to find the specific line, we neutralize the BUILD_BUG_ON macro 
          # in ALL LRNG files. We replace it with '(void)', turning the check into a harmless no-op.
          echo "Neutralizing BUILD_BUG_ON in all LRNG files..."
          find drivers/char/lrng/ -name "*.c" -exec sed -i 's/BUILD_BUG_ON/(void)/g' {} +

          # --- PART B: UPGRADE TO OFFICIAL LZ4 (Dev Branch) ---
          echo "Upgrading to Official LZ4 (dev branch) with fast_dec_loop..."
          
          # Official LZ4 Dev Branch (Contains the latest fast_dec_loop)
          # We use the 'dev' branch because 'master' is often outdated or missing on this repo.
          OFFICIAL_URL="https://raw.githubusercontent.com/lz4/lz4/dev/lib"
          
          # 1. Download the unified lz4.c file to both kernel file names
          # We download the SAME file to both places because official LZ4 is merged.
          wget -O lib/lz4/lz4_compress.c "$OFFICIAL_URL/lz4.c"
          wget -O lib/lz4/lz4_decompress.c "$OFFICIAL_URL/lz4.c"
          wget -O lib/lz4/lz4hc_compress.c "$OFFICIAL_URL/lz4hc.c"
          wget -O lib/lz4/lz4defs.h "$OFFICIAL_URL/lz4.h"
          wget -O include/linux/lz4.h "$OFFICIAL_URL/lz4.h"

          # 2. Kernel-ize the Headers
          # Official LZ4 uses userspace headers (<stdlib.h>, <string.h>) which fail in kernel.
          # We replace them with Kernel equivalents (<linux/slab.h>, <linux/string.h>).
          echo "Patching headers for Kernel compatibility..."
          find lib/lz4/ -name "*.c" -exec sed -i 's/#include <stdlib.h>/#include <linux\/kernel.h>\n#include <linux\/slab.h>/g' {} +
          find lib/lz4/ -name "*.c" -exec sed -i 's/#include <string.h>/#include <linux\/string.h>/g' {} +
          
          # 3. PREVENT DUPLICATE SYMBOLS (Crucial Step)
          # Since we downloaded lz4.c to *both* files, they both contain ALL functions.
          # We must rename the unused functions in each file so the linker doesn't crash.
          
          # In lz4_decompress.c -> Rename compression functions to prevent collision
          sed -i 's/LZ4_compress/LZ4_compress_DISABLED/g' lib/lz4/lz4_decompress.c
          
          # In lz4_compress.c -> Rename decompression functions to prevent collision
          sed -i 's/LZ4_decompress/LZ4_decompress_DISABLED/g' lib/lz4/lz4_compress.c

          # 4. Force Enable the Fast Decode Loop
          # We insert the definition at the top of the decompress file to force it ON.
          sed -i '1i #define LZ4_FAST_DEC_LOOP 1' lib/lz4/lz4_decompress.c

          # 5. Fix Function Names for Kernel Calls
          # The kernel expects lowercase names (lz4_compress) but official uses CamelCase (LZ4_compress).
          # We map them back so the kernel can find them.
          sed -i 's/LZ4_compress_default/lz4_compress/g' lib/lz4/lz4_compress.c
          sed -i 's/LZ4_decompress_safe/lz4_decompress/g' lib/lz4/lz4_decompress.c

          # Verification
          if grep -q "LZ4_FAST_DEC_LOOP" lib/lz4/lz4_decompress.c; then
            echo "✅ Success: LZ4 Dev Branch injected and Fast Loop enabled."
          else
            echo "❌ Error: Fast Loop check failed."
          fi
          
          # 3. Modify gki_defconfig for optimizations
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          {
            echo "CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y"
            echo "CONFIG_LRNG=y"
            
            # 1. Unlock the Advanced TCP Menu
            echo "CONFIG_TCP_CONG_ADVANCED=y"
            
            # 2. Enable Fair Queueing (REQUIRED for BBR)
            echo "CONFIG_NET_SCH_FQ=y"
            echo "CONFIG_DEFAULT_FQ=y"
            
            # 3. Enable BBR
            echo "CONFIG_TCP_CONG_BBR=y"
            echo "CONFIG_DEFAULT_BBR=y"
            
            # --- Tweak 4: Enable MGLRU (Better Multitasking/RAM Management) ---
            # This is native to 5.15 and extremely stable
            echo "CONFIG_LRU_GEN=y"
            echo "CONFIG_LRU_GEN_ENABLED=y"
            echo "CONFIG_LRU_GEN_STATS=y"

            # ZRAM CONFIGURATION (The Safe Way)
            echo "CONFIG_ZRAM=m"
            echo "CONFIG_ZSMALLOC=m"
            echo "CONFIG_ZRAM_DEF_COMP_LZ4=y" 
            echo "CONFIG_LZ4_COMPRESS=y"
            echo "CONFIG_LZ4_DECOMPRESS=y"

            # --- Tweak 5: Disable Debugging Overhead (Raw Performance) ---
            # Disabling SLUB_DEBUG reduces overhead for every memory allocation
            #echo "CONFIG_SLUB_DEBUG=n"
            #echo "CONFIG_PAGE_POISONING=n"
            #echo "CONFIG_DEBUG_KERNEL=n"
            #echo "CONFIG_DEBUG_MISC=n"
            #echo "CONFIG_DEBUG_INFO=n"
            
            # --- Tweak 6: Enable WireGuard (Faster VPN Support) ---
            #echo "CONFIG_WIREGUARD=y"
          } >> $DEFCONFIG
          
          # 4. Use SED to REMOVE Cubic as the default and INSERT BBR
          # We replace the boolean switch
          sed -i 's/CONFIG_DEFAULT_CUBIC=y/CONFIG_DEFAULT_BBR=y/' $DEFCONFIG
          
          # We replace the text string (This is the important part you were missing!)
          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/' $DEFCONFIG

          sed -i 's/CONFIG_ZRAM_DEF_COMP_LZO=y/CONFIG_ZRAM_DEF_COMP_LZ4=y/' $DEFCONFIG
          
          # Set ZRAM and ZSMALLOC to built-in (y)
          # sed -i 's/CONFIG_ZRAM=m/CONFIG_ZRAM=y/' $DEFCONFIG
          # sed -i 's/CONFIG_ZSMALLOC=m/CONFIG_ZSMALLOC=y/' $DEFCONFIG

          # Adding BBG support
          # wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          # echo "CONFIG_BBG=y" >> ./arch/arm64/configs/gki_defconfig
          # sed -i 's/\(CONFIG_LSM="[^"]*\)"/\1,baseband_guard"/' ./arch/arm64/configs/gki_defconfig
          # sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' ./security/Kconfig
          

      - name: Set up swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: Build the kernel
        run: |
          cd kernel
          chmod +x scripts/build.sh
          ./scripts/build.sh 2>&1 | tee "$GITHUB_WORKSPACE/build.log"
    
      - name: Package image with AnyKernel3
        id: package
        run: |
          set -euxo pipefail
          unzip "${GITHUB_WORKSPACE}/anykernel.zip" -d anykernel/
          cp kernel/out/arch/arm64/boot/Image.gz anykernel/
          # Build final name
          ZIP_NAME="common-5.15.${KERNEL_VERSION}-3d64R-wild${WILD_KSU_VERSION}_${WILD_VER_CODE}-susfs${SUSFS_VERSION}_${SUSFS_COMMIT}-manual"
          cd anykernel
          zip -r0 ../"${ZIP_NAME}".zip ./*
          echo "zip_path=$GITHUB_WORKSPACE/${ZIP_NAME}.zip" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          cd ..

      - name: Upload the flashable kernel
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.package.outputs.zip_name}}
          path: anykernel/
      
      - name: Create GitHub Release and upload asset
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: experimental_build-${{ github.run_id }} 
          target_commitish: ${{ github.sha }}
          name: "Wild_KSU Kernel Build by ${{ github.repository }}"
          generate_release_notes: true
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   
