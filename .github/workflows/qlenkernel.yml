name: Build kernel qlenlen (KSU Next Kprobes & BBG)
on:
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4 

      - name: Set up the toolchain
        run: |
          sudo apt update
          sudo apt purge -y firefox
          sudo apt-mark hold firefox
          sudo apt upgrade -y
          sudo apt install -y \
          bc bison flex build-essential git curl \
          libelf-dev libssl-dev liblz4-tool lz4 \
          pahole dwarves cpio \
          python3 python-is-python3 \
          tar perl zip zlib1g-dev


      - name: Clone source
        run: |
          # git clone --depth=1 -b android13-5.15 https://github.com/samsung-sm8550/kernel_samsung_sm8550-common.git kernel
          # git clone --depth=1 -b android13-5.15 https://github.com/naoyukikun/kernel_samsung_sm8550-common.git kernel
          git clone --depth=1 -b ksu https://github.com/qlenlen/android_kernel_samsung_sm8550.git kernel

          # Determine the current kernel version
          echo "KERNEL_VERSION=$(grep -m1 '^SUBLEVEL =' ./kernel/Makefile | awk '{print $3}')" >> $GITHUB_ENV
          
      - name: Apply KernelSU Next (Kprobes) and Baseband Guard
        run: |
          set -euxo pipefail
          cd kernel
          
          # --- KernelSU Next Setup ---
          # Determine the tag of the latest release of KernelSU Next
          echo "KSUNEXT_VERSION=$(curl -s "https://api.github.com/repos/KernelSU-Next/KernelSU-Next/tags" \
          | jq -r '.[0].name' | sed 's/^v//' | tr -d '.')" >> $GITHUB_ENV

          # Integrate the latest DEV version of KernelSU Next into the source
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s dev

          # Compute version code
          COMMITS="$(git -C "./KernelSU-Next" rev-list --count HEAD || echo 0)"
          NEXT_VER_CODE=$((30000 + COMMITS))
          echo "NEXT_VER_CODE=$NEXT_VER_CODE" >> "$GITHUB_ENV"
          
          # --- Configure Kprobes (Default Hook Method) ---
          # We force enable Kprobes in the config to ensure KSU works without manual hooks
          echo "CONFIG_KPROBES=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_HAVE_KPROBES=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPROBE_EVENTS=y" >> ./arch/arm64/configs/gki_defconfig

          # --- Adding BBG support ---
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> ./arch/arm64/configs/gki_defconfig
          sed -i 's/\(CONFIG_LSM="[^"]*\)"/\1,baseband_guard"/' ./arch/arm64/configs/gki_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' ./security/Kconfig
          

      - name: Set up swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: Build the kernel
        run: |
          set -euxo pipefail
          cd kernel
          chmod +x scripts/build.sh
          ./scripts/build.sh 2>&1 | tee "$GITHUB_WORKSPACE/build.log"

      - name: Package image with AnyKernel3
        id: package
        run: |
          set -euxo pipefail
          unzip "${GITHUB_WORKSPACE}/anykernel.zip" -d anykernel/
          cp kernel/out/arch/arm64/boot/Image.gz anykernel/
          
          # Build final name (Removed SUSFS and Manual Hook refs, added Kprobes)
          ZIP_NAME="common-5.15.${KERNEL_VERSION}-3d64R-next${KSUNEXT_VERSION}_${NEXT_VER_CODE}-kprobes-BBG-$(date +%d%m%y-%H%M%S)"
          
          cd anykernel
          zip -r0 ../"${ZIP_NAME}".zip ./*
          echo "zip_path=$GITHUB_WORKSPACE/${ZIP_NAME}.zip" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          cd ..

      - name: Upload the flashable kernel
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.package.outputs.zip_name}}
          path: anykernel/
      
      - name: Create GitHub Release and upload asset
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: experimental_build-${{ github.run_id }} 
          target_commitish: ${{ github.sha }}
          name: "Kernel Build by ${{ github.repository }}"
          generate_release_notes: true
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
